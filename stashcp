#!/bin/bash

#Usage: stashcp [-d] -f <wanted file> -l <location to be copied to>

doflag=0
file=""
loc="."
while getopts ":df:l:" opt; do
    case $opt in 
	d)
	    doflag=1
	    ;;
	f)
	    file=$OPTARG
	    ;;
	l)
	    loc=$OPTARG
	    ;;
	\?)
	    echo "Invalid option: -$OPTARG" >&2
	    ;;
    esac
done

#set prefix to proper format
myprefix=$(echo $STASHPREFIX | rev | cut -c 2- | rev)

if [ ${#myprefix} -lt 6 ]
then
    myprefix="root://data.ci-connect.net/"
fi
if [ $doflag -eq 1 ]
then
    echo "I think my STASHPREFIX is $STASHPREFIX"
    echo "I think my prefix is $myprefix"
fi

#try pulling from closest cache
#if xrdcp doesn't finish in 30 minutes, stop
if [ $doflag -eq 1 ]
then
    timeout 30m xrdcp -v -d 2 -f $myprefix://$file $loc 2>&1
else
    timeout 30m $(xrdcp -f $myprefix://$file $loc > /dev/null 2>&1)
    echo "I did this"
fi
res=$?

#check to see if the pull worked, and file exists and has non-zero size
#if not, pull from trunk
myfile=$(echo $1 | rev | cut -d/ -f1 | rev)
if [ $res -ne 0 ]
then
    if [ $doflag -eq 1 ]
    then
	echo "Pull from $myprefix failed."
	echo "Trying to pull from trunk."
    fi
    timeout 30m xrdcp -v -d 2 -f root://data.ci-connect.net://$file $loc 2>&1
    res=$?
    if [ $res -ne 0 ]
    then		
	echo "Stashcp failed."
    elif [ $doflag -eq 1 ]
    then
	echo "Pull from trunk was successful."
    fi
elif [ $doflag -eq 1 ]
then
    echo "Pull from $myprefix was successful."
fi
