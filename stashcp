#!/bin/bash

#Usage: stashcp <wanted file> <location to be copied to>

#set prefix to proper format
myprefix=$(echo $STASHPREFIX | rev | cut -c 2- | rev)

if [ ${#myprefix} -lt 6 ]
then
    myprefix="root://data.ci-connect.net/"
fi

#try pulling from closest cache
#if xrdcp doesn't finish in 30 minutes, stop
timeout 30m xrdcp -v -d 2 -f $myprefix://$1 $2 2>&1

res=$?

#check to see if the pull worked, and file exists and has non-zero size
#if not, pull from trunk
myfile=$(echo $1 | rev | cut -d/ -f1 | rev)
if [ $res -ne 0 ]
then
    echo "Pull from $STASHPREFIX failed."
    echo "Trying to pull from trunk."
    timeout 30m xrdcp -v -d 2 -f root://data.ci-connect.net://$1 $2 2>&1
    res=$?
    if [ $res -ne 0 ]
    then
		echo "Stashcp failed."
    else
		echo "Pull from trunk was successful."
    fi
else
    echo "Pull from $STASHPREFIX was successful."
fi
