#!/bin/bash

#Usage: stashcp [-d] -s <source> -l <location to be copied to>

debug=-1
file=""
loc="."
while getopts ":ds:l:" opt; do
    case $opt in 
	d)
	    debug=2
	    ;;
	s)
	    source=$OPTARG
	    ;;
	l)
	    loc=$OPTARG
	    ;;
	\?)
	    echo "Invalid option: -$OPTARG" >&2
	    ;;
    esac
done

#set prefix to proper format
myprefix=$(echo $STASHPREFIX | rev | cut -c 2- | rev)

if [ ${#myprefix} -lt 6 ]
then
    myprefix="root://data.ci-connect.net/"
fi
if [ $debug -eq 2 ]
then
    echo "I think my STASHPREFIX is $STASHPREFIX"
    echo "I think my prefix is $myprefix"
fi

#try pulling from closest cache
#if xrdcp doesn't finish in 30 minutes, stop
#check to see if chosen path is a file or directory
isdir=$(xrdfs $myprefix stat $source | grep "IsDir" | wc -l)
if [ isdir -eq 0 ]
then
	files=($source)
else
	files=$(xrdfs $myprefix ls $source)
fi
echo $files

#pull here

##res=$?

###check to see if the pull worked, and file exists and has non-zero size
###if not, pull from trunk
##myfile=$(echo $1 | rev | cut -d/ -f1 | rev)
##if [ $res -ne 0 ]
##then
##    if [ $debug -eq 2 ]
##    then
##		echo "Pull from $myprefix failed."
##		echo "Trying to pull from trunk."
##	fi
##	timeout 30m xrdcp -d $debug -f root://data.ci-connect.net://$file $loc 2>&1
##  res=$?
##    if [ $res -ne 0 ]
##    then		
##		echo "Stashcp failed."
##    elif [ $debug -eq 2 ]
##    then
##		echo "Pull from trunk was successful."
##    fi
##elif [ $debug -eq 2 ]
##then
##    echo "Pull from $myprefix was successful."
##fi
