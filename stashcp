#!/bin/bash

#Usage: stashcp <wanted file> <location to be copied to>

doflag=0

while getopts ":d" opt; do
    case $opt in 
	d)
	    doflag=1
	    ;;
	\?)
	    echo "Invalid option: -$OPTARG" >&2
	    ;;
    esac
done

#set prefix to proper format
myprefix=$(echo $STASHPREFIX | rev | cut -c 2- | rev)

if [ ${#myprefix} -lt 6 ]
then
    myprefix="root://data.ci-connect.net/"
fi
if [ $doflag -eq 1 ]
then
    echo "I think my STASHPREFIX is $STASHPREFIX"
    echo "I think my prefix is $myprefix"
fi

#try pulling from closest cache
#if xrdcp doesn't finish in 30 minutes, stop
timeout 30m xrdcp -v -d 2 -f $myprefix://$1 $2 2>&1

res=$?

#check to see if the pull worked, and file exists and has non-zero size
#if not, pull from trunk
myfile=$(echo $1 | rev | cut -d/ -f1 | rev)
if [ $res -ne 0 ]
then
    if [ $doflag -eq 1 ]
    then
	echo "Pull from $myprefix failed."
	echo "Trying to pull from trunk."
    fi
    timeout 30m xrdcp -v -d 2 -f root://data.ci-connect.net://$1 $2 2>&1
    res=$?
    if [ $res -ne 0 ]
    then
		echo "Stashcp failed."
    elif [ $doflag -eq 1 ]
		echo "Pull from trunk was successful."
    fi
elif [ $doflag -eq 1 ]
    echo "Pull from $myprefix was successful."
fi
